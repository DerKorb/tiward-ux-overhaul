(function(){"use strict";const he="rgba(0, 0, 0, 0.8)",se=[[],[{position:[160,290]}],[{position:[120,20]},{position:[160,380]}],[{position:[150,270]},{position:[190,10]},{position:[200,380]}]],de=[[256,220],[256,180],[256,220],[256,180]];async function ge(){const j=await import("https://www.twilightwars.com/js/api.js"),{skeletonHexArray:r}=await import("https://www.twilightwars.com/js/board-creation.js"),t=await j.getBoardSystems(),a=await j.getPlayers(),o=new Image;o.src="data:image/png;base64,"+ve,await new Promise(S=>{o.onload=S}),t.forEach(async S=>{var F,D,f,C;const k=S.number===51?r[r.length-1]:r[S.position];await pe(a,S,o,k),(F=k.userData.boardTokens)==null||F.controlTokens.forEach(G=>{G.visible=!1}),(D=k.userData.boardTokens)==null||D.infantry.forEach(G=>{G.visible=!1}),(f=k.userData.boardTokens)==null||f.pds.forEach(G=>{G.visible=!1}),(C=k.userData.boardTokens)==null||C.spaceDock.forEach(G=>{G.visible=!1}),k.material.map.needsUpdate=!0,k.material.needsUpdate=!0})}const ve="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";async function pe(j,r,t,a){var Y;const{CanvasTexture:o,Mesh:S,MeshBasicMaterial:k}=await import("https://www.twilightwars.com/js/vendor/three/build/three.module.js"),{createHexagonGeometry:F}=await import("https://www.twilightwars.com/js/utils/geometries.js"),D=document.createElement("canvas"),f=D.getContext("2d"),C=25;D.width=512,D.height=512;const G={Alpha:"red",Beta:"blue",Delta:"green"},z=j.reduce((T,V)=>(T[V.faction]=V.color,T),{}),H={red:"rgba(255, 0, 0, 1.0)",blue:"rgba(0, 0, 255, 1.0)",green:"rgba(0, 255, 0, 1.0)",yellow:"rgba(255, 255, 0, 1.0)",purple:"rgba(255, 0, 255, 1.0)",black:"rgba(0, 0, 0, 1.0)",orange:"rgba(255, 165, 0, 1.0)"},Z={red:"rgba(255, 150, 150, 1)",blue:"rgba(150, 150, 255, 1)",green:"rgba(150, 255, 150, 1)",yellow:"rgba(255, 255, 0, 1)",purple:"rgba(255, 150, 255, 1)",orange:"rgba(255, 150, 0, 1)",white:"white"},te=(Y=r.units)==null?void 0:Y[0],E=te?H[te.color]:null;E&&(f.fillStyle=E,f.fillRect(0,0,D.width,D.height),f.globalCompositeOperation="destination-in",f.drawImage(t,-D.width*.1,-D.height*.1,D.width*1.2,D.height*1.2),f.globalCompositeOperation="source-over");function N(T,V,U,B,P="white",I=!1,R){f.font=`bold ${T}px Arial`;const X=f.measureText(V).width,q=U-X/2;f.fillStyle=P,f.fillText(V,I?q:U,B),R&&(f.strokeStyle=R,f.lineWidth=2,f.strokeText(V,I?q:U,B))}function O(T,V,U,B,P,I="white"){f.beginPath(),f.moveTo(T+P,V),f.lineTo(T+U-P,V),f.quadraticCurveTo(T+U,V,T+U,V+P),f.lineTo(T+U,V+B-P),f.quadraticCurveTo(T+U,V+B,T+U-P,V+B),f.lineTo(T+P,V+B),f.quadraticCurveTo(T,V+B,T,V+B-P),f.lineTo(T,V+P),f.quadraticCurveTo(T,V,T+P,V),f.closePath(),f.fillStyle=I,f.fill()}r.anomaly&&N(C*1.5,r.anomaly,256,50,"white",!0);const Q={Alpha:"🔴",Beta:"🔵",Delta:"🟢",Yellow:"🟡"};r.wormhole&&N(C*3.5,Q[r.wormhole]??r.wormhole,256,500,G[r.wormhole],!0),r.commandTokens&&r.commandTokens.forEach((T,V)=>{const U=z[T];f.lineWidth=20,f.beginPath();const B=2*Math.PI/6*V,P=256+226*Math.cos(B),I=256+266*Math.sin(B),R=256+226*Math.cos(B+2*Math.PI/6),X=256+266*Math.sin(B+2*Math.PI/6);f.moveTo(P,I),f.lineTo(R,X),f.strokeStyle=U,f.stroke()});for(let T=0;T<6;T++){const V=E??"black";f.lineWidth=5,f.beginPath();const U=2*Math.PI/6*T,B=256+256*Math.cos(U),P=256+296*Math.sin(U),I=256+256*Math.cos(U+2*Math.PI/6),R=256+296*Math.sin(U+2*Math.PI/6);f.moveTo(B,P),f.lineTo(I,R),f.strokeStyle=V,f.stroke()}if(r.planets){let T=0;for(const V of r.planets)K(V,T++)}const _=new o(D),x=F(.9),$=new k({map:_});new S(x,$),a.material.onBeforeCompile=function(T){T.uniforms.canvasTexture={value:_},T.fragmentShader=`
        uniform sampler2D canvasTexture;
      `+T.fragmentShader,T.fragmentShader=T.fragmentShader.replace("gl_FragColor = vec4( outgoingLight, diffuseColor.a );",`
        vec4 tex1Color = texture2D( map, vUv );
        vec4 canvasColor = texture2D( canvasTexture, vUv );
        gl_FragColor = vec4(canvasColor.a * canvasColor.rgb + tex1Color.rgb * (1.0 - canvasColor.a), 1.0);
        `)};function K(T,V){const U=se[r.planets.length][V].position[0],B=se[r.planets.length][V].position[1],P=j.find(n=>n.planetCards.find(A=>A.name===T.name));function I(n,A,s){const i=P?Z[P.color]:"white";f.fillStyle="white",n.filter(l=>l.name==="PDS").forEach((l,u)=>{N(C,"🛡",A+10+u*30,s-25,i)}),n.filter(l=>l.name==="Space Dock").forEach((l,u)=>{N(C,"🏗",A+10+u*30,s,i)});const c=n.some(l=>l.name==="Infantry"&&l.upgraded);N(C,`🥆${c?"+":""}`,A+82,s+35,i),f.font=`bold ${C*2}px Arial`,N(C*2,n.filter(l=>l.name==="Infantry").length.toString(),A+95,s,i,!0)}const R=P?P.planetCards.find(n=>n.name===T.name):null,X=`${T.resources}/${T.influence}`;let q,J="";switch(T.tech){case"Warfare":J="🔴";break;case"Biotic":J="🟢";break;case"Cybernetic":q="white",J="🟡";break;case"Propulsion":q="white",J="🔵";break}f.font=`bold ${C}px Arial`;const e=f.measureText(X).width;if(e>0){switch(T.trait){case"Hazardous":f.fillStyle="red";break;case"Industrial":f.fillStyle="green";break;case"Cultural":f.fillStyle="blue";break;default:f.fillStyle="white"}f.fillStyle=q??"white";const n=P?z[P.faction]:"white";f.font=`bold ${C*2}px Arial`,O(U,B,200,100,10,he),T.units&&I(T.units,U+80,B+50),N(C*2,X,U+10,B+50,Z[n]),R!=null&&R.exhausted&&(f.lineWidth=5,f.beginPath(),f.moveTo(U+25-e/2,B+30),f.lineTo(U+25+e*1.5,B+30),f.strokeStyle=Z[n],f.stroke()),N(C*.9,T.name+J,U+10,B+85,Z[n])}}if(r.units){let T=function(U,B,P,I=80){var n;Object.entries(U).length*I;const X=((n=r.units[0])==null?void 0:n.color)??"white",q=["Fi","Fi+","In","In+"],J=["🛦","🛦+","🥆","🥆+"],e=[[90,231,331],[90,231,331],[410,231,331],[410,231,331]];for(let A=0;A<q.length;A++)U[q[A]]&&(N(C*3,`${J[A]}`,e[A][0],e[A][1],X,!0,"white"),N(C*3,`${U[q[A]]?U[q[A]]:""}`,e[A][0],e[A][2],X,!0,"white"))};const V=r.units.reduce((U,B)=>{const P=B.upgraded?B.name.slice(0,2)+"+":B.name.slice(0,2);return U[P]=(U[P]||0)+1,U},{});f.font=`bold ${C*2}px Arial`,de[r.planets.length],T(V)}}function me(j){throw new Error('Could not dynamically require "'+j+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var ue={},ie={},ce;function ye(){return ce||(ce=1,function(j){(function(r){r.createMatrix=function(t,a,o){for(var S=new Array(t),k=0;k<t;k++)S[k]=new Array(a),o!==void 0&&S[k].fill(o);return S.rows=t,S.columns=a,S},r.Problem=function(t,a,o){this.distribution=t,this.attacker=a,this.defender=o},r.DistributionBase=function(t,a){this.min=t,this.max=a},r.DistributionBase.prototype.at=function(t){return this[t]||0},r.DistributionBase.prototype.toString=function(){if(this.min===void 0||this.max===void 0)return"no stats";var t="Min: "+this.min+", Max: "+this.max+". ",a=0;t+="[";for(var o=Math.min(this.min,-1);o<=Math.max(this.max,1);++o)o===0&&(t+="| "),t+=S(this.at(o),3)+" ",a+=this.at(o),o===0&&(t+="| ");return t+="]",t+=" "+S(a,3),t+=". "+S(this.downTo(-1),3)+":"+S(this.downTo(1),3),t;function S(k,F){var D=Math.pow(10,F);return Math.round(k*D)/D}},r.DistributionBase.prototype.downTo=function(t){if(t===0)return this.at(t);var a=0;if(t<0)for(var o=this.min;o<=t;o++)a+=this.at(o);else for(var o=t;o<=this.max;o++)a+=this.at(o);return a},r.EmpiricalDistribution=function(){},r.EmpiricalDistribution.prototype=Object.create(r.DistributionBase.prototype),r.EmpiricalDistribution.prototype.increment=function(t){this[t]=this.at(t)+1,this.min===void 0?this.min=t:t<this.min&&(this.min=t),this.max===void 0?this.max=t:this.max<t&&(this.max=t)},r.EmpiricalDistribution.prototype.normalize=function(){for(var t=0,a=this.min;a<=this.max;++a)t+=this.at(a);if(t!==0)for(var a=this.min;a<=this.max;++a)this[a]=this.at(a)/t},r.EnsembleSplit=function(t){this.subproblems={},this.parentProblem=t},r.EnsembleSplit.prototype.increment=function(t,a,o,S,k){if(k!==0){t=t.collapseRanges(o),a=a.collapseRanges(S);var F=this._subproblemKey(t,a);this.subproblems[F]||(this.subproblems[F]=this._problemFactory(t,a)),this.subproblems[F].distribution[o-t.dead()][S-a.dead()]+=k}},r.EnsembleSplit.prototype.getSubproblems=function(){var t=this.subproblems;return Object.keys(this.subproblems).map(function(a){return t[a]})},r.EnsembleSplit.prototype._problemFactory=function(t,a){var o=t.rangesLength(),S=a.rangesLength(),k=r.createMatrix(this.parentProblem.distribution.rows-o,this.parentProblem.distribution.columns-S,0),F=f(this.parentProblem.attacker,t.ranges),D=f(this.parentProblem.defender,a.ranges);return new r.Problem(k,F,D);function f(C,G){for(var z=!0,H=0;H<G.length/2;++H)if(!isNaN(G[H*2])){z=!1;break}if(z)return C;for(var Z=C.slice(),H=G.length/2-1;0<=H;--H)isNaN(G[H*2])||Z.splice(G[H*2],G[H*2+1]-G[H*2]||1);return Z}},r.EnsembleSplit.prototype._subproblemKey=function(t,a){return"a"+t.rangesKey()+"d"+a.rangesKey()},r.Victim=function(){this.ranges=[]},r.Victim.prototype.addRange=function(t,a){var o=this.ranges;if(!isNaN(t)&&t!==a){if(o.length){if(o[o.length-1]===t){o[o.length-1]=a===void 0?t+1:a;return}if(o[o.length-1]===void 0&&o[o.length-2]+1===t){a===void 0?o[o.length-1]=t+1:o[o.length-1]=a;return}}t+1===a?this.ranges.push(t,void 0):this.ranges.push(t,a)}},r.Victim.prototype.rangesLength=function(){for(var t=0,a=0;a<this.ranges.length/2;++a)t+=o(this.ranges,a);return t;function o(S,k){var F=k*2;return isNaN(S[F])?0:isNaN(S[F+1])?1:S[F+1]-S[F]}},r.Victim.prototype.dead=function(){return this._dead!==void 0?this._dead:this.rangesLength()},r.Victim.prototype.collapseRanges=function(t){var a=this.ranges;if(a.length&&(a[a.length-1]===t||a[a.length-1]===void 0&&a[a.length-2]+1===t)){var o;return o=new r.Victim,o.ranges=a.slice(0,a.length-2),o._dead=this.rangesLength(),o}return this},r.Victim.prototype.rangesKey=function(){for(var t=[],a=0;a<this.ranges.length/2;++a)t.push(this.ranges[a*2]+(this.ranges[a*2+1]===void 0?"":"-"+this.ranges[a*2+1]));return t.join(",")},r.Victim.Null=new r.Victim,r.binarySearch=function(t,a,o){for(var S=0,k=t.length-1;S<=k;){var F=k+S>>1,D=o(a,t[F]);if(D>0)S=F+1;else if(D<0)k=F-1;else return F}return-S-1}})(j)}(ie)),ie}var Ae={},le;function be(){return le||(le=1,function(j){(function(r){r.dieSides=10,r.BattleType={Space:"Space",Ground:"Ground"},r.BattleSide={attacker:"attacker",defender:"defender",opponent:function(k){return{attacker:"defender",defender:"attacker"}[k]}},r.SideUnits={attacker:"attackerUnits",defender:"defenderUnits"};var t={Flagship:"Flagship",WarSun:"WarSun",Dreadnought:"Dreadnought",Cruiser:"Cruiser",Carrier:"Carrier",Destroyer:"Destroyer",Fighter:"Fighter",Ground:"Ground",PDS:"PDS"};r.UnitType=t;var a={Flagship:"X",WarSun:"W",Dreadnought:"D",Cruiser:"C",Destroyer:"+",Carrier:"V",Fighter:"F",Ground:"G",PDS:"P"};r.Race={Arborec:"Arborec",Creuss:"Creuss",Hacan:"Hacan",JolNar:"JolNar",L1Z1X:"L1Z1X",Letnev:"Letnev",Mentak:"Mentak",Muaat:"Muaat",Naalu:"Naalu",Saar:"Saar",Sardakk:"Sardakk",Sol:"Sol",Virus:"Virus",Winnu:"Winnu",Xxcha:"Xxcha",Yin:"Yin",Yssaril:"Yssaril"},r.RacesDisplayNames={Arborec:"Arborec",Creuss:"Creuss",Hacan:"Hacan",JolNar:"Jol-Nar",L1Z1X:"L1Z1X",Letnev:"Letnev",Mentak:"Mentak",Muaat:"Muaat",Naalu:"Naalu",Virus:"Nekro Virus",Saar:"Saar",Sardakk:"Sardakk N'orr",Sol:"Sol",Winnu:"Winnu",Xxcha:"Xxcha",Yin:"Yin",Yssaril:"Yssaril"};function o(k,F,D){this.title=k,this.description=F,this.limitedTo=D}o.prototype.availableFor=function(k){return this.limitedTo===void 0||this.limitedTo===k},r.ActionCards={moraleBoost:new o("Morale Boost 1st round","+1 dice modifier to all units during the first battle round"),fireTeam:new o("Fire Team 1st round","Reroll dice after first round of invasion combat"),fighterPrototype:new o("Fighter Prototype","+2 dice modifier to Fighters during the first battle round"),bunker:new o("Bunker","-4 dice modifier to Bombardment rolls","defender"),experimentalBattlestation:new o("Experimental Battlestation","Additional unit with Space Cannon 5(x3)"),maneuveringJets:new o("Maneuvering Jets","Cancel 1 Space Cannon hit"),riskDirectHit:new o("Risk Direct Hit","Damage units vulnerable to Direct Hit before killing off fodder")},r.Technologies={antimassDeflectors:new o("Antimass Deflectors","-1 to opponents' Space Cannon rolls"),gravitonLaser:new o("Graviton Laser System","Space Cannon hits should be applied to non-fighters if possible"),plasmaScoring:new o("Plasma Scoring","One additional die for one unit during Space Cannon or Bombardment"),magenDefense:new o("Magen Defense Grid","Opponent doesn't throw dice for one round if you have Planetary Shield","defender"),x89Omega:new o("X-89 Bacterial Weapon Ω","Destroy all by bombardment if at least one destroyed","attacker"),magenDefenseOmega:new o("Magen Defense Grid Ω","1 hit at the start of ground combat when having structures","defender"),hasDock:new o("Has Dock","Defender has a dock for Magen Defence Grid Ω","defender"),duraniumArmor:new o("Duranium Armor","After each round repair 1 unit that wasn't damaged this round"),assaultCannon:new o("Assault Cannon","Opponent destroys 1 non-Fighter ship if you have at least 3 non-Fighters")},r.Agendas={publicizeSchematics:new o("Publicize Weapon Schematics","WarSuns don't sustain damage"),conventionsOfWar:new o("Conventions of War","No bombardment","defender"),prophecyOfIxth:new o("Prophecy of IXTH","+1 to Fighters rolls")},r.Promissory={letnevMunitionsFunding:new o("Munitions Reserves / War Funding 1st round","Reroll dice during first space combat round"),tekklarLegion:new o("Tekklar Legion","+1 in invasion combat. -1 to Sardakk if he's the opponent")},r.RaceSpecificTechnologies={Letnev:{nonEuclidean:new o("Non-Euclidean Shielding","Sustain Damage absorbs 2 hits"),l4Disruptors:new o("L4 Disruptors","During an Invasion units cannot use Space Cannon against you","attacker")},Sardakk:{valkyrieParticleWeave:new o("Valkyrie Particle Weave","If opponent produces at least one hit in Ground combat, you produce one additional hit")}},r.UnitInfo=function(){function k(F,D){this.type=F;var f=a[this.type];this.shortType=D.isDamageGhost?f.toLowerCase():f,this.battleValue=D.battleValue||NaN,this.battleDice=D.battleDice!==void 0?D.battleDice:1,this.bombardmentValue=D.bombardmentValue||NaN,this.bombardmentDice=D.bombardmentDice||0,this.spaceCannonValue=D.spaceCannonValue||NaN,this.spaceCannonDice=D.spaceCannonDice||0,this.barrageValue=D.barrageValue||NaN,this.barrageDice=D.barrageDice||0,this.sustainDamageHits=D.sustainDamageHits||0,this.isDamageGhost=D.isDamageGhost||!1,this.damageCorporeal=void 0,this.damaged=!1,this.damagedThisRound=!1,this.race=D.race,this.cost=D.cost}return k.prototype.clone=function(){return new k(this.type,this)},k.prototype.toDamageGhost=function(){var F=new k(this.type,{sustainDamageHits:this.sustainDamageHits,battleDice:0,isDamageGhost:!0});return F.damageCorporeal=this,this.damaged=!1,this.damagedThisRound=!1,F},k}(),r.ThrowType={Battle:"battle",Bombardment:"bombardment",SpaceCannon:"spaceCannon",Barrage:"barrage"},r.ThrowValues={battle:"battleValue",bombardment:"bombardmentValue",spaceCannon:"spaceCannonValue",barrage:"barrageValue"},r.ThrowDice={battle:"battleDice",bombardment:"bombardmentDice",spaceCannon:"spaceCannonDice",barrage:"barrageDice"},r.StandardUnits={WarSun:new r.UnitInfo(t.WarSun,{sustainDamageHits:1,battleValue:3,battleDice:3,bombardmentValue:3,bombardmentDice:3,cost:12}),Dreadnought:new r.UnitInfo(t.Dreadnought,{sustainDamageHits:1,battleValue:5,bombardmentValue:5,bombardmentDice:1,cost:4}),Cruiser:new r.UnitInfo(t.Cruiser,{battleValue:7,cost:2}),Carrier:new r.UnitInfo(t.Carrier,{battleValue:9,cost:3}),Destroyer:new r.UnitInfo(t.Destroyer,{battleValue:9,barrageValue:9,barrageDice:2,cost:1}),Fighter:new r.UnitInfo(t.Fighter,{battleValue:9,cost:.5}),PDS:new r.UnitInfo(t.PDS,{spaceCannonValue:6,spaceCannonDice:1}),Ground:new r.UnitInfo(t.Ground,{battleValue:8,cost:.5}),ExperimentalBattlestation:new r.UnitInfo("Bloodthirsty Space Dock",{spaceCannonValue:5,spaceCannonDice:3})},r.RaceSpecificUnits={Sardakk:{Flagship:new r.UnitInfo(t.Flagship,{sustainDamageHits:1,battleValue:6,battleDice:2,race:r.Race.Sardakk,cost:8}),Dreadnought:new r.UnitInfo(t.Dreadnought,{sustainDamageHits:1,battleValue:5,bombardmentValue:4,bombardmentDice:2,cost:4})},JolNar:{Flagship:new r.UnitInfo(t.Flagship,{sustainDamageHits:1,battleValue:6,battleDice:2,race:r.Race.JolNar,cost:8})},Winnu:{Flagship:new r.UnitInfo(t.Flagship,{sustainDamageHits:1,battleValue:7,battleDice:void 0,race:r.Race.Winnu,cost:8})},Xxcha:{Flagship:new r.UnitInfo(t.Flagship,{sustainDamageHits:1,battleValue:7,battleDice:2,spaceCannonValue:5,spaceCannonDice:3,race:r.Race.Xxcha,cost:8})},Yin:{Flagship:new r.UnitInfo(t.Flagship,{sustainDamageHits:1,battleValue:9,battleDice:2,race:r.Race.Yin,cost:8})},Yssaril:{Flagship:new r.UnitInfo(t.Flagship,{sustainDamageHits:1,battleValue:5,battleDice:2,race:r.Race.Yssaril,cost:8})},Sol:{Flagship:new r.UnitInfo(t.Flagship,{sustainDamageHits:1,battleValue:5,battleDice:2,race:r.Race.Sol,cost:8}),Ground:new r.UnitInfo(t.Ground,{battleValue:7,cost:.5})},Creuss:{Flagship:new r.UnitInfo(t.Flagship,{sustainDamageHits:1,battleValue:5,battleDice:1,race:r.Race.Creuss,cost:8})},L1Z1X:{Flagship:new r.UnitInfo(t.Flagship,{sustainDamageHits:1,battleValue:5,battleDice:2,race:r.Race.L1Z1X,cost:8})},Mentak:{Flagship:new r.UnitInfo(t.Flagship,{sustainDamageHits:1,battleValue:7,battleDice:2,race:r.Race.Mentak,cost:8})},Naalu:{Flagship:new r.UnitInfo(t.Flagship,{sustainDamageHits:1,battleValue:9,battleDice:2,race:r.Race.Naalu,cost:8}),Fighter:new r.UnitInfo(t.Fighter,{battleValue:8,cost:.5})},Virus:{Flagship:new r.UnitInfo(t.Flagship,{sustainDamageHits:1,battleValue:9,battleDice:2,race:r.Race.Virus,cost:8})},Arborec:{Flagship:new r.UnitInfo(t.Flagship,{sustainDamageHits:1,battleValue:7,battleDice:2,race:r.Race.Arborec,cost:8})},Letnev:{Flagship:new r.UnitInfo(t.Flagship,{sustainDamageHits:1,battleValue:5,battleDice:2,bombardmentValue:5,bombardmentDice:3,race:r.Race.Letnev,cost:8})},Saar:{Flagship:new r.UnitInfo(t.Flagship,{sustainDamageHits:1,battleValue:5,battleDice:2,barrageValue:6,barrageDice:4,race:r.Race.Saar,cost:8})},Muaat:{Flagship:new r.UnitInfo(t.Flagship,{sustainDamageHits:1,battleValue:5,battleDice:2,race:r.Race.Muaat,cost:8})},Hacan:{Flagship:new r.UnitInfo(t.Flagship,{sustainDamageHits:1,battleValue:7,battleDice:2,race:r.Race.Hacan,cost:8})}},r.StandardUpgrades={Dreadnought:new r.UnitInfo(t.Dreadnought,{sustainDamageHits:1,battleValue:5,bombardmentValue:5,bombardmentDice:1,cost:4}),Cruiser:new r.UnitInfo(t.Cruiser,{battleValue:6,cost:2}),Destroyer:new r.UnitInfo(t.Destroyer,{battleValue:8,barrageValue:6,barrageDice:3,cost:1}),Fighter:new r.UnitInfo(t.Fighter,{battleValue:8,cost:.5}),PDS:new r.UnitInfo(t.PDS,{spaceCannonValue:5,spaceCannonDice:1}),Ground:new r.UnitInfo(t.Ground,{battleValue:7,cost:.5})},r.RaceSpecificUpgrades={Sol:{Carrier:new r.UnitInfo(t.Carrier,{sustainDamageHits:1,battleValue:9,cost:3}),Ground:new r.UnitInfo(t.Ground,{battleValue:6,cost:.5})},L1Z1X:{Dreadnought:new r.UnitInfo(t.Dreadnought,{sustainDamageHits:1,battleValue:4,bombardmentValue:4,bombardmentDice:1,cost:4})},Naalu:{Fighter:new r.UnitInfo(t.Fighter,{battleValue:7,cost:.5})},Muaat:{WarSun:new r.UnitInfo(t.WarSun,{sustainDamageHits:1,battleValue:3,battleDice:3,bombardmentValue:3,bombardmentDice:3,cost:10})}},r.MergedUnits={},r.MergedUpgrades={};for(var S in r.Race)r.MergedUnits[S]=Object.assign({},r.StandardUnits,r.RaceSpecificUnits[S]),r.MergedUpgrades[S]=Object.assign({},r.StandardUpgrades,r.RaceSpecificUpgrades[S]);r.expandFleet=function(k,F){var D=k.options||{attacker:{},defender:{}},f=k.battleType,C=D[F],G=r.BattleSide.opponent(F),z=D[G],H=r.MergedUnits[C.race],Z=r.MergedUpgrades[C.race],te=f===r.BattleType.Space&&z.race===r.Race.Mentak&&(k[r.SideUnits[G]][t.Flagship]||{count:0}).count!==0,E=[],N=k[r.SideUnits[F]];for(var O in t)for(var Q=N[O]||{count:0},_=0;_<Q.count;_++){var x=(Q.upgraded?Z:H)[O],$=x.clone();E.push($),x.sustainDamageHits>0&&!te&&!(O===t.WarSun&&C.publicizeSchematics)&&(_<Q.count-(Q.damaged||0)?E.push($.toDamageGhost()):$.damaged=!0)}var K=I(),Y=f===r.BattleType.Space&&C.race===r.Race.Virus&&(N[t.Flagship]||{count:0}).count!==0,T=f===r.BattleType.Ground&&C.race===r.Race.Naalu&&(N[t.Flagship]||{count:0}).count!==0,V=R(Y),U={};U[t.Ground]=1,U[t.Fighter]=2;var B,P;return T?(P=(N[t.Fighter]||{}).upgraded&&!(N[t.Ground]||{}).upgraded&&E.find(function(n){return n.type===t.Ground}),B=J):(N[t.Dreadnought]||{}).upgraded?B=q:B=X,E.sort(B),f===r.BattleType.Space&&C.experimentalBattlestation&&E.push(r.StandardUnits.ExperimentalBattlestation),E.comparer=B,E.filterForBattle=e,E;function I(){return[t.Flagship,t.WarSun,t.Dreadnought,t.Cruiser,t.Destroyer,t.Carrier,t.Fighter]}function R(n){var A=[],s=0;for(var i in t)A[i]=s++;if(n){var c=A[t.Ground];A[t.Ground]=A[t.Fighter],A[t.Fighter]=c}return A}function X(n,A){var s=V[n.type]-V[A.type],i=(n.isDamageGhost?1:0)-(A.isDamageGhost?1:0),c=(A.damaged?1:0)-(n.damaged?1:0);if(C.riskDirectHit){var l=i*1e3+s*10+c;return C.race!==r.Race.Letnev?l:n.type===t.Flagship&&n.isDamageGhost?A.type===t.Flagship&&A.isDamageGhost?0:1:A.type===t.Flagship&&A.isDamageGhost?-1:l}else return s*1e3+i*10+c}function q(n,A){return C.riskDirectHit?X(n,A):n.type===t.Dreadnought&&n.isDamageGhost?A.type===t.Dreadnought&&A.isDamageGhost?0:1:A.type===t.Dreadnought&&A.isDamageGhost?-1:X(n,A)}function J(n,A){var s=U[n.type]-U[A.type];return P?n===P?-1:A===P?1:-s:s}function e(){var n=this.filter(function(A){return f===r.BattleType.Space?K.indexOf(A.type)>=0||Y&&A.type===r.UnitType.Ground:A.type===t.Ground||T&&A.type===r.UnitType.Fighter});return n.comparer=this.comparer,n}},r.upgradeable=function(k,F){return!!(r.StandardUpgrades.hasOwnProperty(F)||r.RaceSpecificUpgrades[k]&&r.RaceSpecificUpgrades[k].hasOwnProperty(F))},r.damageable=function(k,F,D){return(D?r.MergedUpgrades:r.MergedUnits)[k][F].sustainDamageHits>0}})(j)}(Ae)),Ae}(function(j){(function(r){var t,a;typeof me=="function"?(t=ye(),a=be()):(t=window,a=window),r.calculator=function(){var o=Q(),S=N();return{computeProbabilities:k};function k(e){var n=e.battleType,A=e.options||{attacker:{},defender:{}},s=a.expandFleet(e,a.BattleSide.attacker),i=a.expandFleet(e,a.BattleSide.defender),c=s.filterForBattle(),l=i.filterForBattle(),u=t.createMatrix(c.length+1,l.length+1,0);u[c.length][l.length]=1;var d=[new t.Problem(u,c,l)],g=S;if(A.attacker.race===a.Race.Mentak){g=S.slice();var h=g[1];if(g[1]=g[2],g[2]=h,g[1].name!=="Mentak racial"||g[2].name!=="Assault Cannon")throw new Error("unexpected pre-battle actions order")}g.forEach(function(v){v.appliesTo===n&&(d=v.execute(d,s,i,A))});for(var y=0;y<d.length;++y)d[y].attacker.length&&d[y].defender.length&&F(d[y],n,s,i,A);var p=new t.DistributionBase(-c.length,l.length),b=c.map(function(v){return[v.shortType]}),w=l.map(function(v){return[v.shortType]});return d.forEach(function(v){p[0]=p.at(0)+v.distribution[0][0];for(var m=1;m<v.distribution.rows;m++)p[-m]=p.at(-m)+v.distribution[m][0],b[m-1].indexOf(v.attacker[m-1].shortType)<0&&b[m-1].push(v.attacker[m-1].shortType);for(var W=1;W<v.distribution.columns;W++)p[W]=p.at(W)+v.distribution[0][W],w[W-1].indexOf(v.defender[W-1].shortType)<0&&w[W-1].push(v.defender[W-1].shortType)}),{distribution:p,attacker:b.map(function(v){return v.reduce(function(m,W){return m+W})}),defender:w.map(function(v){return v.reduce(function(m,W){return m+W})})}}function F(e,n,A,s,i){var c=O(n,i.attacker,i.defender,e.attacker,!0),l=O(n,i.defender,i.attacker,e.defender,!0),u=n===a.BattleType.Ground&&i.attacker.fireTeam||n===a.BattleType.Space&&i.attacker.letnevMunitionsFunding,d=n===a.BattleType.Ground&&i.defender.fireTeam||n===a.BattleType.Space&&i.defender.letnevMunitionsFunding,g=n===a.BattleType.Ground&&i.defender.magenDefense&&s.some(R(a.UnitType.PDS))&&!A.some(R(a.UnitType.WarSun)),h={valkyrieParticleWeave:n===a.BattleType.Ground,winnuFlagship:n===a.BattleType.Space};if(n===a.BattleType.Ground&&i.defender.magenDefenseOmega&&(i.defender.hasDock||s.some(R(a.UnitType.PDS)))){var y=x([1],e.attacker.length+1),p=x([0,1],e.defender.length);p.unshift([1]),E(e,y,p,i)}if(c!==void 0||l!==void 0||g||u||d){var b;g?b=function(){return x([1],e.attacker.length+1)}:b=function(){return f(e.attacker,a.ThrowType.Battle,c,u)};var w=function(){return f(e.defender,a.ThrowType.Battle,l,d)};if(i.attacker.race===a.Race.L1Z1X&&n===a.BattleType.Ground){var v=e.distribution[0];e.distribution[0]=new Array(e.distribution.columns),e.distribution[0].fill(0),E(e,b,w,i,h),S.find(function(W){return W.name==="Bombardment"}).execute([e],A,s,i);for(var m=0;m<e.distribution.columns;++m)e.distribution[0][m]+=v[m]}else E(e,b,w,i,h);n===a.BattleType.Space&&I(e,i)}if(g&&(c!==void 0||u)){var b=function(){return f(e.attacker,a.ThrowType.Battle,c,u)},w=function(){return f(e.defender,a.ThrowType.Battle,O(n,i.defender,i.attacker,e.defender,!1))};E(e,b,w,i,h)}D(e,n,A,s,i)}function D(e,n,A,s,i){var c=e.distribution,l=f(e.attacker,a.ThrowType.Battle,O(n,i.attacker,i.defender,e.attacker,!1)),u=f(e.defender,a.ThrowType.Battle,O(n,i.defender,i.attacker,e.defender,!1));if(i.attacker.race===a.Race.L1Z1X&&n===a.BattleType.Ground){var d=$(A,s,i);d.length===1&&(d=void 0)}else var d=void 0;for(var g=n===a.BattleType.Space&&(i.attacker.race===a.Race.Winnu&&e.attacker.some(R(a.UnitType.Flagship))||i.defender.race===a.Race.Winnu&&e.defender.some(R(a.UnitType.Flagship))),h=i.attacker.race===a.Race.Yin?J(e.attacker,R(a.UnitType.Flagship))+1:0,y=i.defender.race===a.Race.Yin?J(e.defender,R(a.UnitType.Flagship))+1:0,p=c.rows-1;0<p;p--)for(var b=c.columns-1;0<b;b--){g&&(i.attacker.race===a.Race.Winnu&&P(e.attacker,e.defender,b)&&(l=f(e.attacker,a.ThrowType.Battle,O(n,i.attacker,i.defender,e.attacker,!1))),i.defender.race===a.Race.Winnu&&P(e.defender,e.attacker,p)&&(u=f(e.defender,a.ThrowType.Battle,O(n,i.defender,i.attacker,e.defender,!1))));var w=Y(l[p],e.defender,b-1,i.defender),v=Y(u[b],e.attacker,p-1,i.attacker),m=H(w,v,b+1,p+1);n===a.BattleType.Ground&&(m=T(m,i,b+1,p+1)),d&&(m=te(m,d,b+1,p+1));var W;if(c[p][b]!==0){W=c[p][b]/(1-m.at(0,0));for(var M=0;M<m.rows;M++)for(var L=0;L<m.columns&&L<=p;L++)if(!(M===0&&L===0)){var ee=p-L,ne=b-M;(ee<h||ne<y)&&(ee=ne=0),c[ee][ne]+=m.at(M,L)*W}c[p][b]=0}}}function f(e,n,A,s){A=A||0;for(var i=[[1]],c=1;c<=e.length;++c){var l=e[c-1],u=G(l,n,A,s);i.push(z(u,i[c-1]))}return i}function C(e,n,A,s){for(var i=[[1]],c=[[1]],l=0;l<e.length;l++){var u=e[l];if(A(u)){var d=G(u,n,s);c=z(c,d)}i.push(c)}return i}function G(e,n,A,s){var i=e[a.ThrowValues[n]],c=e[a.ThrowDice[n]];if(c===0)return[1];A=A||0;var l=typeof A=="function"?A:function(m){return A},u=[],d=Math.max(Math.min((i-1-l(e))/a.dieSides,1),0);if(e.type===a.UnitType.Flagship&&e.race===a.Race.JolNar&&n===a.ThrowType.Battle){var g=1-d,h=Math.min(.8,d),y=Math.max(0,g-.2),p=Math.max(0,.2-g),b=Math.min(.2,g);u[0]=h*(s?h:1),u[1]=y+(s?d*y:0),u[2]=p+(s?d*p:0),u[3]=b+(s?d*b:0)}else u[0]=d,s&&(u[0]=u[0]*u[0]),u[1]=1-u[0];for(var w=u,v=1;v<c;v++)w=z(w,u);return w}function z(e,n){for(var A=[],s=0;s<e.length+n.length-1;++s)A[s]=0;for(var i=0;i<e.length;++i)for(var c=0;c<n.length;++c)A[i+c]+=e[i]*n[c];return A}function H(e,n,A,s){return{rows:Math.min(A,e.length),columns:Math.min(s,n.length),at:function(i,c){var l=e[i];if(i===A-1)for(;++i<e.length;)l+=e[i];var u=n[c];if(c===s-1)for(;++c<n.length;)u+=n[c];return l*u}}}function Z(e,n){return{rows:e.length,columns:n.length,at:function(A,s){return e[A]*n[s]}}}function te(e,n,A,s){return!n||n.length===1?e:V({rows:e.rows+n.length-1,columns:e.columns,at:function(i,c){for(var l=0,u=0;u<=i&&u<n.length;++u)if(i-u<e.rows){var d=n[u];l+=d*e.at(i-u,c)}return l}},A,s)}function E(e,n,A,s,i){var c=e.distribution;i&&!(i.winnuFlagship&&s.attacker.race===a.Race.Winnu)&&(n=n()),i&&!(i.winnuFlagship&&s.defender.race===a.Race.Winnu)&&(A=A()),i=i||{};for(var l=0;l<c.rows;l++)for(var u=0;u<c.columns;u++)if(c[l][u]!==0){var d=n,g=A;i.winnuFlagship&&(s.attacker.race===a.Race.Winnu&&(P(e.attacker,e.defender,u),d=n()),s.defender.race===a.Race.Winnu&&(P(e.defender,e.attacker,l),g=A()));var h=Y(d[l],e.defender,u-1,s.defender),y=Y(g[u],e.attacker,l-1,s.attacker),p=H(h,y,u+1,l+1);i.valkyrieParticleWeave&&(p=T(p,s,u+1,l+1));for(var b=0;b<p.rows;b++)for(var w=0;w<p.columns;w++)b===0&&w===0||(c[l-w][u-b]+=p.at(b,w)*c[l][u]);c[l][u]*=p.at(0,0)}}function N(){return[{name:"Space Cannon -> Ships",appliesTo:a.BattleType.Space,execute:function(e,n,A,s){var i=[],c=s.attacker.race===a.Race.Virus&&n.some(R(a.UnitType.Flagship))&&n.some(R(a.UnitType.Ground)),l=s.defender.race===a.Race.Virus&&A.some(R(a.UnitType.Flagship))&&A.some(R(a.UnitType.Ground));return e.forEach(function(h){var y=u(n,s.attacker,s.defender),p=u(A,s.defender,s.attacker);if(s.attacker.gravitonLaser||s.defender.gravitonLaser||c||l){for(var b=new t.EnsembleSplit(h),w=h.distribution,v=0;v<w.rows;v++)for(var m=0;m<w.columns;m++)if(w[v][m]!==0)for(var W=Z(y,p),M=0;M<W.rows;M++)for(var L=0;L<W.columns;L++){var ee=g(h.attacker,v,L,s.attacker,s.defender),ne=g(h.defender,m,M,s.defender,s.attacker);b.increment(ee,ne,v,m,W.at(M,L)*w[v][m])}var ae=b.getSubproblems();ae.forEach(function(Te){I(Te,s,h)}),i.push.apply(i,ae)}else{var re=x(y,h.attacker.length+1),De=x(p,h.defender.length+1);E(h,re,De,s),I(h,s),i.push(h)}}),i;function u(h,y,p){var b=p.antimassDeflectors?-1:0,w=h.filter(d),v;return y.plasmaScoring?v=K(w,a.ThrowType.SpaceCannon,b):v=_(w,a.ThrowType.SpaceCannon,b),B(v,p.maneuveringJets?1:0)}function d(h){return h.spaceCannonDice!==0}function g(h,y,p,b,w){if(p===0||y===0)return t.Victim.Null;if(!w.gravitonLaser&&!b.nonEuclidean&&!h.some(R(a.UnitType.Ground))){var L=new t.Victim;return L._dead=Math.min(p,h.map(ee).reduce(ne)),L}for(var v=[],M=null,m=y-1;0<=m&&0<p;){var W=h[m];W.type===a.UnitType.Fighter&&w.gravitonLaser||W.type===a.UnitType.Ground?M=null:(M===null&&(M=[m+1,m+1],v.push(M)),M[0]--,p-=ee(W)),m--}var M=null;if(w.gravitonLaser)for(var m=y-1;0<=m&&0<p;--m)h[m].type===a.UnitType.Fighter&&(M===null&&(M=[m+1,m+1],v.push(M)),M[0]--,p-=ee(h[m]));v.sort(function(ae,re){return ae[0]-re[0]});var L=new t.Victim;return v.forEach(function(ae){L.addRange(ae[0],ae[1])}),L;function ee(ae){return ae.isDamageGhost&&b.nonEuclidean?2:1}function ne(ae,re){return ae+re}}}},{name:"Assault Cannon",appliesTo:a.BattleType.Space,execute:function(e,n,A,s){if(!s.attacker.assaultCannon&&!s.defender.assaultCannon)return e;var i=[];return e.forEach(function(u){for(var d=new t.EnsembleSplit(u),g=c(u.attacker,s.attacker.assaultCannon),h=c(u.defender,s.defender.assaultCannon),y=l(u.attacker,h<u.defender.length,!0),p=l(u.defender,g<u.attacker.length,!1),b=u.distribution,w=0;w<b.rows;w++)for(var v=0;v<b.columns;v++)if(b[w][v]!==0){var m=h<v?y[w]:t.Victim.Null,W=g<w?p[v]:t.Victim.Null;d.increment(m,W,w,v,b[w][v])}var M=d.getSubproblems();M.forEach(function(L){I(L,s,u)}),i.push.apply(i,M)}),i;function c(u,d){for(var g=0,h=0;h<u.length;h++)if(X(u[h])&&g++,g>=3&&d)return h;return h}function l(u,d,g){var h=new Array(u.length+1);if(!d)h.fill(t.Victim.Null);else{h[0]=t.Victim.Null;for(var y=void 0,p=void 0,b=void 0,w=0;w<u.length;++w){(g?X:q)(u[w])?(y=u[w],p=w,b=void 0):y&&u[w].damageCorporeal===y&&(b=w);var v=new t.Victim;p!==void 0&&(v.addRange(p,void 0),b!==void 0&&v.addRange(b,void 0)),h[w+1]=v}}return h}}},{name:"Mentak racial",appliesTo:a.BattleType.Space,execute:function(e,n,A,s){return e.forEach(function(i){if(s.attacker.race!==a.Race.Mentak&&s.defender.race!==a.Race.Mentak)return;function c(d,g){var h=0,y=g.moraleBoost?1:0;return C(d,a.ThrowType.Battle,function(p){return 2<=h?!1:p.type===a.UnitType.Cruiser||p.type===a.UnitType.Destroyer?(h++,!0):!1},y)}var l,u;s.attacker.race===a.Race.Mentak?l=c(i.attacker,s.attacker):l=x([1],i.attacker.length+1),s.defender.race===a.Race.Mentak?u=c(i.defender,s.defender):u=x([1],i.defender.length+1),E(i,l,u,s),I(i,s)}),e}},{name:"Anti-Fighter Barrage",appliesTo:a.BattleType.Space,execute:function(e,n,A,s){var i=[];return e.forEach(function(d){for(var g=new t.EnsembleSplit(d),h=C(d.attacker,a.ThrowType.Barrage,c),y=C(d.defender,a.ThrowType.Barrage,c),p=l(d.attacker,R(a.UnitType.Fighter)),b=l(d.defender,R(a.UnitType.Fighter)),w=d.distribution,v=0;v<w.rows;v++)for(var m=0;m<w.columns;m++)if(w[v][m]!==0)for(var W=Z(h[v],y[m]),M=0;M<W.rows;M++)for(var L=0;L<W.columns;L++){var ee=u(p,v,L),ne=u(b,m,M);g.increment(ee,ne,v,m,W.at(M,L)*w[v][m])}i.push.apply(i,g.getSubproblems())}),i;function c(d){return d.barrageDice!==0}function l(d,g){for(var h=void 0,y=0;y<d.length;y++)if(h===void 0)g(d[y])&&(h=y);else if(!g(d[y]))break;return h===void 0&&(h=y),{from:h,to:y}}function u(d,g,h){if(h===0||g<d.from)return t.Victim.Null;var y=new t.Victim;return y.addRange(d.from,Math.min(g,d.from+h,d.to)),y}}},{name:"Bombardment",appliesTo:a.BattleType.Ground,execute:function(e,n,A,s){return e.forEach(function(i){var c=$(n,A,s),l=x(c,i.attacker.length+1),u=x([1],i.defender.length+1);E(i,l,u,s)}),e}},{name:"Space Cannon -> Ground Forces",appliesTo:a.BattleType.Ground,execute:function(e,n,A,s){return e.forEach(function(i){if(!s.attacker.l4Disruptors){var c=x([1],i.attacker.length+1),l=s.attacker.antimassDeflectors?-1:0,u=A.filter(R(a.UnitType.PDS)),d;s.defender.plasmaScoring?d=K(u,a.ThrowType.SpaceCannon,l):d=_(u,a.ThrowType.SpaceCannon,l);var g=x(B(d,s.attacker.maneuveringJets?1:0),i.defender.length+1);E(i,c,g,s)}}),e}}]}function O(e,n,A,s,i){for(var c=void 0,l=0;l<o.length;l++)if(!(!i&&o[l].firstRoundOnly)){var u=o[l].apply(e,n,A,s);if(u&&!c){c=u;continue}u&&(c=d(c,u))}return c;function d(g,h){var y=typeof g=="function",p=typeof h=="function";return y||p?function(b){return(y?g(b):g)+(p?h(b):h)}:g+h}}function Q(){return[{name:"moraleBoost",firstRoundOnly:!0,apply:function(e,n){return n.moraleBoost?1:0}},{name:"fighterPrototype",firstRoundOnly:!0,apply:function(e,n){return e===a.BattleType.Space&&n.fighterPrototype?function(A){return A.type===a.UnitType.Fighter?2:0}:0}},{name:"Sardakk",firstRoundOnly:!1,apply:function(e,n){return n.race===a.Race.Sardakk?1:0}},{name:"Sardakk Flagship",firstRoundOnly:!1,apply:function(e,n,A,s){return n.race===a.Race.Sardakk&&e===a.BattleType.Space&&s.some(R(a.UnitType.Flagship))?function(i){return i.type!==a.UnitType.Flagship?1:0}:0}},{name:"JolNar",firstRoundOnly:!1,apply:function(e,n){return n.race===a.Race.JolNar?-1:0}},{name:"prophecyOfIxth",firstRoundOnly:!1,apply:function(e,n){return n.prophecyOfIxth?function(A){return A.type===a.UnitType.Fighter?1:0}:0}},{name:"tekklarLegion",firstRoundOnly:!1,apply:function(e,n){return e===a.BattleType.Ground&&n.tekklarLegion&&n.race!==a.Race.Sardakk?1:0}},{name:"tekklarLegion of the opponent",firstRoundOnly:!1,apply:function(e,n,A){return e===a.BattleType.Ground&&A.tekklarLegion&&n.race===a.Race.Sardakk?-1:0}}]}function _(e,n,A,s){return f(e,n,A,s).pop()}function x(e,n){var A=new Array(n);return A.fill(e),A}function $(e,n,A){var s=!A.defender.conventionsOfWar&&(!n.some(R(a.UnitType.PDS))||e.some(R(a.UnitType.WarSun))||A.attacker.race===a.Race.Letnev&&e.some(R(a.UnitType.Flagship)));if(!s)return[1];var i=A.defender.bunker?-4:0,c=e.filter(d),l=A.attacker.plasmaScoring?K(c,a.ThrowType.Bombardment,i):_(c,a.ThrowType.Bombardment,i);if(A.attacker.x89Omega){var u=new Array(n.length+1);u.fill(0),u[0]=l[0],u[u.length-1]=l.reduce(function(g,h){return g+h})-l[0],l=u}return l;function d(g){return g.bombardmentDice!==0}}function K(e,n,A){var s=f(e,n,A).pop(),i=U(e,a.ThrowValues[n]);if(i){var c=i.clone();c[a.ThrowDice[n]]=1;var l=G(c,n,A);s=z(l,s)}return s}function Y(e,n,A,s){if(s.nonEuclidean&&e.length>2){for(var i=e.slice(),c=1;c<i.length&&0<A;c++)n[A].isDamageGhost&&B(i,1,c),A--;return i}else return e}function T(e,n,A,s){return!n.attacker.valkyrieParticleWeave&&!n.defender.valkyrieParticleWeave?e:V({rows:e.rows+(n.attacker.valkyrieParticleWeave?1:0),columns:e.columns+(n.defender.valkyrieParticleWeave?1:0),at:function(i,c){if(i===0&&c===0)return e.at(0,0);if(i===0)return n.attacker.valkyrieParticleWeave||c===e.columns?0:e.at(i,c);if(c===0)return n.defender.valkyrieParticleWeave||i===e.rows?0:e.at(i,c);if(i===1&&c===1&&n.attacker.valkyrieParticleWeave&&n.defender.valkyrieParticleWeave)return(e.columns===1?0:e.at(0,1))+(e.rows===1?0:e.at(1,0));if(n.attacker.valkyrieParticleWeave&&n.defender.valkyrieParticleWeave&&(i===e.rows&&c===1||i===1&&c===e.columns))return 0;var l=n.attacker.valkyrieParticleWeave&&!(n.defender.valkyrieParticleWeave&&c===1)?1:0,u=n.defender.valkyrieParticleWeave&&!(n.attacker.valkyrieParticleWeave&&i===1)?1:0;return e.at(i-l,c-u)}},A,s)}function V(e,n,A){return e.rows<=n&&e.columns<=A?e:{rows:Math.min(e.rows,n),columns:Math.min(e.columns,A),at:function(s,i){for(var c=0,l=s===this.rows-1?e.rows:s+1,u=i===this.columns-1?e.columns:i+1,d=s;d<l;++d)for(var g=i;g<u;++g)c+=e.at(d,g);return c}}}function U(e,n){for(var A=null,s=1/0,i=0;i<e.length;i++)e[i][n]<s&&(A=e[i],s=e[i][n]);return A}function B(e,n,A){A=A||0;for(var s=0;s<n;++s){e.length>A+1&&(e[A]+=e[A+1]);for(var i=A+2;i<e.length;i++)e[i-1]=e[i];e.length>A+1&&e.pop()}return e}function P(e,n,A){var s=null;return e.filter(R(a.UnitType.Flagship)).forEach(function(i){i.battleDice=s===null?s=n.slice(0,A).filter(q).length:s}),s!==null}function I(e,n,A){if(n.attacker.race===a.Race.Yin||n.defender.race===a.Race.Yin){var s=c(e,n,A,a.BattleSide.attacker),i=c(e,n,A,a.BattleSide.defender);l(e.distribution,s,e.distribution.columns),l(e.distribution,e.distribution.rows,i)}function c(u,d,g,h){var y=J(u[h],R(a.UnitType.Flagship));return d[h].race===a.Race.Yin?g&&u[h].length<g[h].length&&y<J(g[h],R(a.UnitType.Flagship))?h===a.BattleSide.attacker?u.distribution.rows:u.distribution.columns:y+1:0}function l(u,d,g){for(var h=0;h<d;++h)for(var y=0;y<g;++y)h===0&&y===0||(u[0][0]+=u[h][y],u[h][y]=0)}}function R(e){return function(n){return n.type===e&&!n.isDamageGhost}}function X(e){return e.type!==a.UnitType.Fighter&&!e.isDamageGhost}function q(e){return e.type!==a.UnitType.Fighter&&e.type!==a.UnitType.Ground&&!e.isDamageGhost}function J(e,n){for(var A=e.length-1;0<=A;--A)if(n(e[A]))return A;return-1}}()})(j)})(ue);const oe={"The Arborec":"Arborec","The Barony of Letnev":"Letnev","The Clan of Saar":"Saar","The Embers of Muaat":"Muaat","The Emirates of Hacan":"Hacan","The Federation of Sol":"Sol","The Ghosts of Creuss":"Creuss","The L1Z1X Mindnet":"L1Z1X","The Mentak Coalition":"Mentak","The Naalu Collective":"Naalu","The Nekro Virus":"Virus","The Sardakk N'orr":"Sardakk","The Universities of Jol-Nar":"JolNar","The Winnu":"Winnu","The Xxcha Kingdom":"Xxcha","The Yin Brotherhood":"Yin","The Yssaril Tribes":"Yssaril"},fe={Flagship:"Flagship","War Sun":"WarSun",Dreadnought:"Dreadnought",Carrier:"Carrier",Cruiser:"Cruiser",Destroyer:"Destroyer",Fighter:"Fighter",PDS:"PDS",Infantry:"Ground","Space Dock":"PDS"};async function ke(){document.getElementById("scene-container");const{camera:j}=await import("https://www.twilightwars.com/js/app.js"),{Raycaster:r,Vector2:t}=await import("https://www.twilightwars.com/js/vendor/three/build/three.module.js"),{allBoardSystems:a}=await import("https://www.twilightwars.com/js/board-creation.js"),{getPlayers:o}=await import("https://www.twilightwars.com/js/api.js"),S=await o(),k=new r,F=new t,D=new Set;function f(C,G){G.x=C.clientX/window.innerWidth*2-1,G.y=-(C.clientY/window.innerHeight)*2+1}window.addEventListener("click",C=>{if(C.button!==0||!C.altKey)return;f(C,F),k.setFromCamera(F,j);const G=k.intersectObjects(a);if(D.has(G[0].object.userData)?D.delete(G[0].object.userData):D.add(G[0].object.userData),D.size>=2){const[H,Z,...te]=Array.from(D);console.log(H,Z,te);const E={};for(const K of H.units){const Y=fe[K.name];E[Y]||(E[Y]={count:0}),E[Y].count++}if(H.units.length===0){alert("Attacking system has no units");return}if(Z.units.length===0){alert("Defending system has no units");return}const N=S.find(K=>K.color===H.units[0].color),O=S.find(K=>K.color===Z.units[0].color);console.log(N,O);const Q={};for(const K of Z.units){const Y=fe[K.name];Q[Y]||(Q[Y]={count:0}),Q[Y].count++}const _=oe[N.faction],x=oe[O.faction],$={attackerUnits:E,defenderUnits:Q,battleType:"Space",options:{attacker:{race:_,riskDirectHit:!0},defender:{race:x,riskDirectHit:!0}}};console.log($);var z=ue.calculator.computeProbabilities($);console.log(z)}})}async function we(){console.log("running main"),await ge(),ke()}we()})();
